<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pack Calculator</title>
    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .table-action-col {
            width: 100px;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="container" style="max-width: 900px;">
    <h1 class="mb-4 text-center text-primary">Packs Calculator</h1>

    <!-- Alert area for global status messages -->
    <div id="alert-area"></div>

    <div class="row g-4">
        <!-- SECTION 1: Manage Pack Sizes -->
        <div class="col-md-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Manage Pack Sizes</h5>
                    <button onclick="fetchSizes()" class="btn btn-sm btn-light" title="Refresh Data">
                        &#x21bb; Refresh
                    </button>
                </div>
                <div class="card-body">
                    <p class="text-muted small">Define available pack sizes. Sizes must be positive integers.</p>
                    
                    <form id="sizes-form" onsubmit="event.preventDefault(); saveSizes();">
                        <div class="table-responsive mb-3" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm table-striped align-middle" id="sizes-table">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Pack Size</th>
                                        <th class="table-action-col">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="sizes-tbody">
                                    <!-- Rows will be generated by JS -->
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addSizeRow()">
                                + Add Row
                            </button>
                            <button type="submit" id="save-btn" class="btn btn-primary">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- SECTION 2: Packs Calculator -->
        <div class="col-md-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Calculate Packs</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small">Enter the number of items to calculate required packs.</p>
                    
                    <form id="calculate-form" onsubmit="event.preventDefault(); calculatePacks();" class="mb-4">
                        <div class="input-group mb-3">
                            <input type="number" id="calculate-amount" class="form-control" placeholder="Amount of items (e.g., 123)" min="1" required>
                            <button class="btn btn-success" type="submit" id="calculate-btn">Calculate</button>
                        </div>
                    </form>

                    <hr>

                    <h6 class="text-success">Results</h6>
                    <div id="calculate-results-container">
                        <p class="text-muted fst-italic" id="no-results-msg">No packs calculated yet.</p>
                        
                        <table class="table table-bordered d-none" id="results-table">
                            <thead class="table-light">
                                <tr>
                                    <th>Pack Size</th>
                                    <th>Quantity Required</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody">
                                <!-- Results generated by JS -->
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- Configuration ---
    // Using relative paths assuming the Go server serves this HTML.
    const ENDPOINTS = {
        GET_SIZES: '/pack/get-sizes',
        SET_SIZES: '/pack/set-sizes',
        CALCULATE: '/calculate'
    };

    // --- State ---
    // We keep a local copy of sizes to render the table easily
    let currentSizes = [];

    // --- DOM Elements ---
    const alertAreaEl = document.getElementById('alert-area');
    const sizesTbodyEl = document.getElementById('sizes-tbody');
    const saveBtnEl = document.getElementById('save-btn');
    const resultsTableEl = document.getElementById('results-table');
    const resultsTbodyEl = document.getElementById('results-tbody');
    const noResultsMsgEl = document.getElementById('no-results-msg');
    const calculateBtnEl = document.getElementById('calculate-btn');

    // --- Utility Functions ---

    function showAlert(message, type = 'success') {
        alertAreaEl.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        // Auto-dismiss after 3 seconds for success messages, longer for errors
        setTimeout(() => {
            const alert = bootstrap.Alert.getOrCreateInstance(document.querySelector('#alert-area .alert'));
            if (alert) alert.close();
        }, type === 'success' ? 3000 : 8000);
    }

    // --- SECTION 1: Manage Pack Sizes ---

    // Render the sizes table based on currentSizes state
    function renderSizesTable() {
        sizesTbodyEl.innerHTML = '';

        if (currentSizes.length === 0) {
            sizesTbodyEl.innerHTML = '<tr><td colspan="2" class="text-center text-muted fst-italic">No sizes defined. Add a row to start.</td></tr>';
            return;
        }

        currentSizes.forEach((size, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input type="number" class="form-control size-input" value="${size}" min="1" placeholder="Enter size">
                </td>
                <td class="table-action-col">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeSizeRow(${index})" title="Remove size">
                        &times;
                    </button>
                </td>
            `;
            sizesTbodyEl.appendChild(row);
        });
    }

    // Add a new empty row
    function addSizeRow() {
        currentSizes.push(''); // push empty string as placeholder for new row
        renderSizesTable();
    }

    // Remove a row by index
    function removeSizeRow(index) {
        // Update current state from DOM before removing, to not lose unsaved edits in other rows
        updateStateFromDOM();
        currentSizes.splice(index, 1);
        renderSizesTable();
    }

    // Helper to sync DOM inputs back to currentSizes state array
    function updateStateFromDOM() {
        const inputs = document.querySelectorAll('.size-input');
        currentSizes = Array.from(inputs).map(input => input.value);
    }

    // GET: Fetch sizes from server
    async function fetchSizes() {
        // Show loading indicator in table
        sizesTbodyEl.innerHTML = '<tr><td colspan="2" class="text-center"><div class="spinner-border spinner-border-sm text-primary" role="status"></div> Loading...</td></tr>';

        try {
            const response = await fetch(ENDPOINTS.GET_SIZES);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            // Expected format: { sizes: [250, 500, 1000] }
            currentSizes = data.sizes || [];
            renderSizesTable();

        } catch (error) {
            console.error('Error fetching sizes:', error);
            showAlert('Failed to load pack sizes.', 'danger');
            sizesTbodyEl.innerHTML = '<tr><td colspan="2" class="text-danger text-center">Error loading data.</td></tr>';
        }
    }

    // POST: Save sizes to server
    async function saveSizes() {
        updateStateFromDOM();

        // Validate: Filter out empty, non-numeric, or non-positive values
        const validSizes = currentSizes
            .map(s => parseInt(s))
            .filter(n => !isNaN(n) && n > 0);

        // Optimistic UI update: remove invalid rows from view immediately
        currentSizes = validSizes; 
        renderSizesTable();

        const originalBtnText = saveBtnEl.innerText;
        saveBtnEl.disabled = true;
        saveBtnEl.innerText = 'Saving...';

        try {
            const response = await fetch(ENDPOINTS.SET_SIZES, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // API expects: { sizes: [...] }
                body: JSON.stringify({ sizes: validSizes })
            });

            if (!response.ok) throw new Error(await response.text() || 'Failed to save');

            showAlert('Pack sizes saved successfully!');
            // Re-fetch to ensure we have server-canonical data (e.g. if server sorted them)
            await fetchSizes();

        } catch (error) {
            console.error('Error saving sizes:', error);
            showAlert(`Error saving: ${error.message}`, 'danger');
        } finally {
            saveBtnEl.disabled = false;
            saveBtnEl.innerText = originalBtnText;
        }
    }

    // --- SECTION 2: Pack Calculator ---

    async function calculatePacks() {
        const amountInput = document.getElementById('calculate-amount');
        const amount = parseInt(amountInput.value);

        if (isNaN(amount) || amount <= 0) {
            showAlert('Please enter a valid positive amount.', 'warning');
            return;
        }

        // UI Loading state
        calculateBtnEl.disabled = true;
        calculateBtnEl.innerText = 'Calculating...';
        resultsTableEl.classList.add('d-none');
        noResultsMsgEl.classList.remove('d-none');
        noResultsMsgEl.innerText = 'Calculating best packs...';

        try {
            const response = await fetch(ENDPOINTS.CALCULATE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // API expects: { amount: 123 }
                body: JSON.stringify({ amount: amount })
            });

            if (!response.ok) throw new Error(await response.text() || 'Calculation failed');

            const data = await response.json();
            // Expected format: { packs: { "250": 1, "500": 2 } }
            renderCalculateResults(data.packs || {});

        } catch (error) {
            console.error('Calculation error:', error);
            showAlert(`Calculation failed: ${error.message}`, 'danger');
            noResultsMsgEl.innerText = 'Calculation failed.';
        } finally {
            calculateBtnEl.disabled = false;
            calculateBtnEl.innerText = 'Calculate';
        }
    }

    function renderCalculateResults(packs) {
        resultsTbodyEl.innerHTML = '';
        
        // Check if we received any packs
        const packSizes = Object.keys(packs);
        if (packSizes.length === 0) {
            noResultsMsgEl.innerText = 'No packs needed for this amount.';
            noResultsMsgEl.classList.remove('d-none');
            resultsTableEl.classList.add('d-none');
            return;
        }

        // Sort pack sizes numerically for better display
        packSizes.sort((a, b) => parseInt(a) - parseInt(b));

        packSizes.forEach(size => {
            const quantity = packs[size];
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${size}</td>
                <td class="fw-bold">${quantity}</td>
            `;
            resultsTbodyEl.appendChild(row);
        });

        // Show table, hide message
        noResultsMsgEl.classList.add('d-none');
        resultsTableEl.classList.remove('d-none');
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', fetchSizes);
</script>
</body>
</html>
